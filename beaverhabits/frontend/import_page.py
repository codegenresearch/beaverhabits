import json\nimport logging\nfrom nicegui import events, ui\nfrom beaverhabits.app.db import User\nfrom beaverhabits.frontend.components import menu_header\nfrom beaverhabits.storage.dict import DictHabitList\nfrom beaverhabits.storage.storage import HabitList\nfrom beaverhabits.views import user_storage\n\nlogging.basicConfig(level=logging.INFO)\n\ndef parse_habit_list(json_text: str) -> HabitList:\n    try:\n        data = json.loads(json_text)\n        habit_list = DictHabitList(data)\n        if not habit_list.habits:\n            raise ValueError("No habits found in the imported data.")\n        return habit_list\n    except json.JSONDecodeError:\n        logging.error("Failed to decode JSON")\n        raise ValueError("Invalid JSON format. Please ensure the file is correctly formatted.")\n\nasync def confirm_import(user: User, json_text: str):\n    dialog = ui.dialog()\n    with dialog, ui.card().classes("w-64"):\n        ui.label("Are you sure you want to import these habits? This will replace your current habits.")\n        with ui.row():\n            ui.button("Yes", on_click=lambda: dialog.submit(True))\n            ui.button("No", on_click=lambda: dialog.submit(False))\n    if await dialog:\n        await merge_and_save_habits(user, json_text)\n\nasync def merge_and_save_habits(user: User, json_text: str):\n    try:\n        new_habits = parse_habit_list(json_text)\n        current_habits = await user_storage.get_user_habit_list(user)\n        if current_habits:\n            merged_habits = await current_habits.merge(new_habits)\n        else:\n            merged_habits = new_habits\n        await user_storage.save_user_habit_list(user, merged_habits)\n        ui.notify(f"Successfully imported {len(new_habits.habits)} habits.", position="top", color="positive")\n        logging.info(f"Imported {len(new_habits.habits)} habits for user {user.email}")\n    except ValueError as ve:\n        ui.notify(str(ve), color="negative", position="top")\n        logging.error(f"ValueError during import: {ve}")\n    except Exception as e:\n        ui.notify(f"Import failed: {str(e)}", color="negative", position="top")\n        logging.error(f"Error during import: {e}")\n\nasync def handle_upload(e: events.UploadEventArguments, user: User):\n    try:\n        json_text = e.content.read().decode("utf-8")\n        await confirm_import(user, json_text)\n    except Exception as e:\n        ui.notify(f"Upload failed: {str(e)}", color="negative", position="top")\n        logging.error(f"Upload failed: {e}")\n\ndef import_page(user: User):\n    menu_header("Import", target=get_root_path())\n    ui.upload(on_upload=lambda e: handle_upload(e, user), max_files=1).props("accept=.json")\n