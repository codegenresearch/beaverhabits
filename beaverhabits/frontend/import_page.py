import json logging from nicegui import events, ui from beaverhabits.app.db import User from beaverhabits.frontend.components import menu_header from beaverhabits.storage.dict import DictHabitList from beaverhabits.storage.meta import get_root_path from beaverhabits.storage.storage import HabitList, merge_habit_lists from beaverhabits.views import user_storage logging.basicConfig(level=logging.INFO) async def import_habit_list_from_json(text: str) -> HabitList:     try:         data = json.loads(text)         habit_list = DictHabitList(data)         if not habit_list.habits:             raise ValueError("No habits found in the JSON file.")         return habit_list     except json.JSONDecodeError as e:         logging.error(f"Failed to decode JSON: {e}")         raise ValueError("Invalid JSON format.")     except ValueError as e:         logging.error(f"Value error: {e}")         raise     except Exception as e:         logging.error(f"Unexpected error: {e}")         raise ValueError("An unexpected error occurred.") async def handle_file_upload(event: events.UploadEventArguments, user: User):     try:         file_content = event.content.read().decode("utf-8")         other = await import_habit_list_from_json(file_content)         current = await user_storage.get_user_habit_list(user)         if current:             merged, added_count, merged_count = merge_habit_lists(current, other)             unchanged_count = len(current.habits) - merged_count             logging.info(f"Added {added_count} new habits, merged {merged_count} existing habits, and kept {unchanged_count} unchanged habits.")         else:             merged = other             added_count = len(other.habits)             logging.info(f"Added {added_count} new habits.")         await user_storage.save_user_habit_list(user, merged)         ui.notify(             f"Successfully imported {added_count} habits.",             position="top",             color="positive",         )     except ValueError as e:         ui.notify(str(e), color="negative", position="top")     except Exception as e:         ui.notify("An unexpected error occurred.", color="negative", position="top")         logging.error(f"Unexpected error: {e}") def render_import_ui_page(user: User):     menu_header("Import Habits", target=get_root_path())     async def on_upload(event: events.UploadEventArguments):         file_content = event.content.read().decode("utf-8")         other = await import_habit_list_from_json(file_content)         confirmation_dialog = display_import_confirmation_dialog(user, len(other.habits))         result = await confirmation_dialog         if result == "Yes":             await handle_file_upload(event, user)     ui.upload(on_upload=on_upload, max_files=1).props("accept=.json")     return def display_import_confirmation_dialog(user: User, habits_count: int):     with ui.dialog() as dialog, ui.card().classes("w-64"):         ui.label(f"Are you sure? Importing this file will add {habits_count} new habits and merge any existing ones.")         with ui.row():             ui.button("Yes", on_click=lambda: dialog.submit("Yes"))             ui.button("No", on_click=lambda: dialog.submit("No"))     return dialog